// Generated by Gemini 3 Pro Preview:
// https://aistudio.google.com/app/prompts?state=%7B%22ids%22:%5B%22175JoNE0qdy-4_yE3PQB9zS7fxQcXs6d2%22%5D,%22action%22:%22open%22,%22userId%22:%22102930743586145414200%22,%22resourceKeys%22:%7B%7D%7D&usp=sharing
#define _XOPEN_SOURCE 700
#include <zlib.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>

#include "kseq.h"
#include "khashl.h"

KSEQ_INIT(gzFile, gzread)
KHASHL_MAP_INIT(KH_LOCAL, kmer_map_t, kmap, uint64_t, char*, kh_hash_uint64, kh_eq_generic)

// Fully populated, static const table for maximum compiler optimization.
// Maps: A/a->0, C/c->1, G/g->2, T/t/U/u->3, Everything else->4
static const unsigned char seq_nt4_table[256] = {
    4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4, 
    4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4, 
    4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,
    4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4, 
    4, 0, 4, 1,  4, 4, 4, 2,  4, 4, 4, 4,  4, 4, 4, 4, // 64: @ A B C D E F G H I J K L M N O
    4, 4, 4, 4,  3, 3, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4, // 80: P Q R S T U V W X Y Z [ \ ] ^ _
    4, 0, 4, 1,  4, 4, 4, 2,  4, 4, 4, 4,  4, 4, 4, 4, // 96: ` a b c d e f g h i j k l m n o
    4, 4, 4, 4,  3, 3, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4, // 112: p q r s t u v w x y z { | } ~ DEL
    4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4, 
    4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4, 
    4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4, 
    4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4, 
    4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4, 
    4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4, 
    4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4, 
    4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4
};

char *c99_strdup(const char *s) {
    if (!s) return NULL;
    size_t len = strlen(s) + 1;
    char *new_s = malloc(len);
    if (new_s) memcpy(new_s, s, len);
    return new_s;
}

int encode_kmer(const char *seq, int len, uint64_t *val) {
    uint64_t x = 0;
    for (int i = 0; i < len; ++i) {
        uint8_t c = seq_nt4_table[(uint8_t)seq[i]];
        if (c > 3) return 0;
        x = (x << 2) | c;
    }
    *val = x;
    return 1;
}

int main(int argc, char *argv[]) {
    if (argc != 3) {
        fprintf(stderr, "Usage: ./find_kmers <queries.fasta> <genome.fasta>\n");
        return 1;
    }

    gzFile fp_query, fp_genome;
    kseq_t *ks;
    kmer_map_t *h = kmap_init();
    khint_t itr;
    int absent;
    int k_len = 0; 

    // 1. Load Queries
    fprintf(stderr, "[INFO] Reading queries from %s...\n", argv[1]);
    fp_query = gzopen(argv[1], "r");
    if (!fp_query) { perror("Failed to open query file"); return 1; }
    
    ks = kseq_init(fp_query);
    uint64_t loaded_count = 0;

    // First record to set K
    if (kseq_read(ks) >= 0) {
        k_len = ks->seq.l;
        if (k_len > 31 || k_len == 0) {
            fprintf(stderr, "[ERROR] Invalid k-mer length: %d\n", k_len);
            return 1;
        }
        fprintf(stderr, "[INFO] Detected k-mer length: %d\n", k_len);

        uint64_t packed;
        if (encode_kmer(ks->seq.s, k_len, &packed)) {
            itr = kmap_put(h, packed, &absent);
            if (absent) kh_val(h, itr) = c99_strdup(ks->name.s);
            loaded_count++;
        }
    } else {
        return 1; // Empty file
    }

    // Remaining records
    while (kseq_read(ks) >= 0) {
        if (ks->seq.l != k_len) continue;
        uint64_t packed;
        if (encode_kmer(ks->seq.s, k_len, &packed)) {
            itr = kmap_put(h, packed, &absent);
            if (absent) {
                kh_val(h, itr) = c99_strdup(ks->name.s); 
                loaded_count++;
            }
        }
    }
    kseq_destroy(ks);
    gzclose(fp_query);
    
    fprintf(stderr, "[INFO] Loaded %lu unique valid %d-mers.\n", (unsigned long)loaded_count, k_len);

    // 2. Scan Genome
    fprintf(stderr, "[INFO] Scanning genome %s...\n", argv[2]);
    fp_genome = gzopen(argv[2], "r");
    if (!fp_genome) { perror("Failed to open genome file"); return 1; }
    
    ks = kseq_init(fp_genome);
    
    const uint64_t mask = (1ULL << (k_len * 2)) - 1;
    const int rc_shift = (k_len - 1) * 2;

    while (kseq_read(ks) >= 0) {
        uint64_t fwd_k = 0; 
        uint64_t rev_k = 0; 
        int len = 0;        
        
        for (int i = 0; i < ks->seq.l; ++i) {
            // Highly optimized table lookup
            uint8_t c = seq_nt4_table[(uint8_t)ks->seq.s[i]];
            
            if (c < 4) {
                fwd_k = ((fwd_k << 2) | c) & mask;
                rev_k = (rev_k >> 2) | (((uint64_t)(c ^ 3)) << rc_shift);
                len++;
                
                if (len >= k_len) {
                    // Check Maps
                    itr = kmap_get(h, fwd_k);
                    if (itr != kh_end(h)) {
                        printf("%s\t%d\t%d\t%s\t0\t+\n", 
                            ks->name.s, i - k_len + 1, i + 1, kh_val(h, itr));
                    }
                    
                    itr = kmap_get(h, rev_k);
                    if (itr != kh_end(h)) {
                        printf("%s\t%d\t%d\t%s\t0\t-\n", 
                            ks->name.s, i - k_len + 1, i + 1, kh_val(h, itr));
                    }
                }
            } else {
                len = 0;
                fwd_k = 0;
                rev_k = 0;
            }
        }
    }

    kseq_destroy(ks);
    gzclose(fp_genome);
    
    for (itr = 0; itr < kh_end(h); ++itr) {
        if (kh_exist(h, itr)) free(kh_val(h, itr));
    }
    kmap_destroy(h);

    return 0;
}
